# Some basic env setup used throughout config
IS_MAC=$([[ $(uname) != Darwin ]]; echo -n $?)
IS_LINUX=$([[ $(uname) != Linux ]]; echo -n $?)

path=($HOME/.bin /usr/texbin/(/) $path)
fpath=(~/.zsh/functions $fpath)
manpath=(/usr/local/share/man /usr/share/man $manpath)

# Enable hooks
typeset -gUa preexec_functions
typeset -gUa precmd_functions
typeset -gUa chpwd_functions

autoload -U ~/.zsh/functions/*(:t)

## smart urls
if [[ -o interactive ]]; then
  autoload -U url-quote-magic
  zle -N self-insert url-quote-magic

  # Colorize me
  autoload colors; colors;
fi

HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
REPORTTIME=60 # print elapsed time when more than 10 seconds

setopt NO_LIST_BEEP
setopt LOCAL_OPTIONS # allow functions to have local options
setopt LOCAL_TRAPS # allow functions to have local traps
setopt CORRECT
setopt CORRECT_ALL
setopt COMPLETE_IN_WORD
setopt NO_ALWAYS_TO_END
setopt NO_LIST_AMBIGUOUS # Don't auto complete until ambiguous
setopt COMPLETE_ALIASES # Treat aliases as unique entities viable for completion
setopt REC_EXACT # Recgonize exact completions even if ambiguous

setopt AUTO_MENU
setopt LIST_ROWS_FIRST # Order completion by row instead of column
# setopt IGNORE_EOF
setopt RC_EXPAND_PARAM # Expand `foo${xx}bar', where the parameter xx is set to (a b c), are substituted with `fooabar foobbar foocbar' instead  of the default `fooa  b foocbar`
# setopt WARN_CREATE_GLOBAL # Warn when creating a global variable accidentally in a function
setopt CLOBBER # allow traditional bash like functionality where > clobbers a file and >> can create a file if none exists

setopt INTERACTIVE_COMMENTS # Allow comments when in an interactive shell
setopt NO_PRINT_EXIT_VALUE # If the command exits with non zero, tell me

setopt SHARE_HISTORY # share history between sessions, it implies incremental history sharing
setopt HIST_VERIFY # Don't immediately execute a command from history, let me edit it first
setopt HIST_IGNORE_ALL_DUPS  # don't record dupes in history
setopt HIST_REDUCE_BLANKS
setopt HIST_IGNORE_SPACE # don't records commands that the first character is a space
setopt HIST_NO_STORE # Don't save the history command (fc -l) in history
setopt HIST_LEX_WORDS

setopt CHECK_JOBS
setopt AUTO_CONTINUE
setopt LONG_LIST_JOBS
setopt NOTIFY
setopt NO_AUTO_RESUME
setopt NO_POSIX_JOBS
setopt NO_BG_NICE # don't nice background tasks
setopt NO_HUP

setopt AUTO_CD
setopt AUTO_PUSHD # every cd pushs onto the stack
setopt PUSHD_SILENT # Don't print out the pushd stack after a pushd or popd
setopt PUSHD_IGNORE_DUPS # Ignore duplicate pushs
setopt PUSHD_TO_HOME # have an empty `pushd` work like `pushd $HOME`

setopt NULL_GLOB # If a glob pattern doesn't match a file, return a blank string
setopt EXTENDED_GLOB # use regex style globing
setopt REMATCH_PCRE # use perl regex matching for the =~ operator

setopt C_BASES # Output hexadecimal and octal values like they are defined in C, e.g. 0xFF or 077

setopt AUTO_PARAM_KEYS # When autocompleting params, if a space is added but something that is supposed to be appened to the param is typed, delete the space
setopt AUTO_PARAM_SLASH # Add a / to the end of a param if the param contains a directory

# Allows any unquoted shell argument of the form identifier=expression to be expanded
# This allows creating configure arguments like --prefix=~nginx to expand to --prefix=/home/nginx
setopt MAGIC_EQUAL_SUBST

# Allow variable substitution in the prompt
setopt PROMPT_SUBST

## pager
export PAGER=less
export LC_ALL='en_US.UTF-8'
export LANG='en_US.UTF-8'
export LC_CTYPE='en_US.UTF-8'

## grep
if [[ -o interactive ]]; then
  export GREP_OPTIONS='--color=auto'
  export GREP_COLOR='1;32'
else
  export GREP_OPTIONS='--color=never'
fi

export EDITOR='vim'

# Add all the local compiled things to the path
for pkg in $HOME/.local/cellar/*(/); do
    version=(${pkg}/*(/oc))
    path=($version[1]/{bin,sbin}(/) $path)
    manpath=($version[1]/share/man(/) $manpath)
done

unset pkg
unset version

path=($HOME/.local/bin(/) $path)

# Load all of your custom configurations from custom/
function {
  local config_file
  for config_file (~/.zsh/envs/*) source $config_file
}

if [[ $IS_MAC -eq 1 ]]; then
  fignore+='.DS_Store'
  export __CF_USER_TEXT_ENCODING="$(printf '0x%X' $(id -u)):0x08000100:0"
fi

if [[ -o interactive ]]; then
  if [[ ! $TERM =~ ^screen ]]; then
    alias screen="screen -dRaA"
  else
    export TERM="screen-256color"
  fi
fi

# Remove duplicates in paths
typeset -gU path cdpath manpath fpath

if [[ -o interactive ]]; then
  # Make a nice colored interactive prompt
  source ~/.zsh/vendor/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
  ZSH_HIGHLIGHT_STYLES[path]=none

  # # Add nice shortcuts like ci" to standard vi mode
  autoload opp
  . ~/.zsh/functions/opp-install
  opp-install

  # Color all stderr lines yellow only when interactive
  if command -v colorize >& /dev/null; then
    exec 2>>(colorize $fg[yellow] $reset_color > /dev/tty &)
  else
    exec 2>>(while read line; do
      print ${fg[yellow]}$line$reset_color > /dev/tty; print -n $'\0'; done &)
  fi
fi

# vim: ft=zsh
